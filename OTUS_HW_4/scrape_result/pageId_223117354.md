[TOTP (Рутокен OTP)](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354)

-







Created by [Нестеров Михаил](https://dev.rutoken.ru/display/~nesterov), last modified by [Кирилл Аверченко](https://dev.rutoken.ru/display/~averchenko) on [Dec 25, 2025](https://dev.rutoken.ru/pages/diffpagesbyversion.action?pageId=223117354&selectedPageVersions=1&selectedPageVersions=2 "Show changes")

- 1 [Общая информация](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%9E%D0%B1%D1%89%D0%B0%D1%8F%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F)
- 2 [Компоненты системы аутентификации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%9A%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82%D1%8B%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
- 3 [Процесс аутентификации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%9F%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
- 4 [Возможные сценарии подготовки к аутентификации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%92%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D1%8B%D0%B5%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B8%D0%BA%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
  - 4.1 [Секретные ключи сгенерированы вне контура организации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%A1%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D1%8B%D0%B5%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%81%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D1%8B%D0%B2%D0%BD%D0%B5%D0%BA%D0%BE%D0%BD%D1%82%D1%83%D1%80%D0%B0%D0%BE%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8)
  - 4.2 [Секретные ключи сгенерированы внутри контура организации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%A1%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D1%8B%D0%B5%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%81%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D1%8B%D0%B2%D0%BD%D1%83%D1%82%D1%80%D0%B8%D0%BA%D0%BE%D0%BD%D1%82%D1%83%D1%80%D0%B0%D0%BE%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8)
- 5 [Почему одноразовые пароли на сервере и Рутокен ОТР могут не совпадать и как это предотвратить](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%9F%D0%BE%D1%87%D0%B5%D0%BC%D1%83%D0%BE%D0%B4%D0%BD%D0%BE%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D1%8B%D0%B5%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D0%B8%D0%BD%D0%B0%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B5%D0%B8%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BD%D0%9E%D0%A2%D0%A0%D0%BC%D0%BE%D0%B3%D1%83%D1%82%D0%BD%D0%B5%D1%81%D0%BE%D0%B2%D0%BF%D0%B0%D0%B4%D0%B0%D1%82%D1%8C%D0%B8%D0%BA%D0%B0%D0%BA%D1%8D%D1%82%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%BE%D1%82%D0%B2%D1%80%D0%B0%D1%82%D0%B8%D1%82%D1%8C)
- 6 [Примеры реализации](https://dev.rutoken.ru/pages/viewpage.action?pageId=223117354#TOTP(%D0%A0%D1%83%D1%82%D0%BE%D0%BA%D0%B5%D0%BDOTP)-%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8)

# Общая информация

Данный документ предназначен для инженеров и разработчиков, которые добавляют поддержку устройств Рутокен OTP  в серверное приложение, клиентский портал или другой ресурс для реализации стандартизированной технологии TOTP.

Рутокен ОТР — это аппаратная клиентская реализация алгоритма TOTP для аутентификации на сервисах. Данное решение обладает рядом ключевых преимуществ:

- низкая стоимость внедрения и обслуживания;
- интуитивно понятный процесс аутентификации;
- возможность аутентификации во внутрикорпоративные сервисы в условиях отсутствия постоянного доступа к сети интернет;
- возможность аутентификации без использования USB-портов.

В Рутокен ОТР реализован алгоритм создания одноразовых паролей на основе времени (TOTP), соответствующий стандарту [RFC6238](https://www.ietf.org/rfc/rfc6238.txt).

# Компоненты системы аутентификации

Для организации системы аутентификации потребуется:

- устройство Рутокен ОТР;
- клиент;
- сервер аутентификации.

В качестве сервера аутентификации можно использовать:

- продукты партнеров, поддерживающие Рутокен OTP:

  - [Secure Authentication Server (SAS)](https://mfasoft.ru/product);
  - [Avanpost FAM](https://www.avanpost.ru/products/avanpost-fam);
  - [Indeed Аccess Мanager](https://indeed-company.ru/indeed-access-manager);
  - [MULTIFACTOR](https://multifactor.ru/);
  - [Trusted.ID](https://trusted.ru/products/id-trusted-net/)
- Opensource-решение: [LinOTP](https://www.linotp.org/).

# Процесс аутентификации

Устройство Рутокен ОТР и сервер аутентификации независимо друг от друга вычисляют одноразовые пароли.

Для корректной работы системы аутентификации на стороне сервера также должна быть внедрена поддержка TOTP.

При попытке аутентификации сервер сравнивает одноразовый пароль, вычисленный на сервере, с одноразовым паролем, предоставленным клиентом. Проверка проходит успешно только в том случае, если и сервер, и Рутокен ОТР используют идентичные секретный ключ и настройки для вычисления одноразовых паролей:

- время;
- алгоритм;
- шаг времени.

Настройки протокола TOTP по умолчанию:

- время — текущее по UTC;
- алгоритм — sha1;
- шаг времени — 30 секунд.

Устройство Рутокен ОТР позволяет импортировать настройки протокола TOTP по технологии NFC с помощью мобильного устройства на базе Android или компьютера с NFC-считывателем.

Приложения для ОС Android или Windows опубликованы на [странице](https://download.rutoken.ru/Rutoken/Utilites/Rutoken_OTP_New?action=show).

Инструкции к приложениям можно найти по [ссылке](https://dev.rutoken.ru/pages/viewpage.action?pageId=191987716).

# Возможные сценарии подготовки к аутентификации

Для успешной проверки одноразовых паролей и корректной аутентификации пользователя необходимо, чтобы секретный ключ и настройки на сервере аутентификации и устройстве Рутокен ОТР были идентичными. Ниже представлены возможные сценарии синхронизации секретного ключа и настроек в зависимости от того, где были сгенерированы секретные ключи.

## Секретные ключи сгенерированы вне контура организации

1. Администратор получает устройства Рутокен ОТР от Компании «Актив» с предзагруженными уникальными секретными ключами и настройками протокола TOTP по умолчанию. Дополнительно прилагается csv-файл с серийными номерами устройств вместе со значениями соответствующих ключей.
2. Администратор переносит серийные номера устройств и соответствующие значения секретных ключей на сервер. На сервере для расчета одноразовых паролей указаны настройки протокола TOTP по умолчанию.
3. Администратор назначает серийный номер токена учетной записи пользователя при выдаче Рутокен ОТР пользователю.

Пример содержимого файла, поставляемого вместе с партией устройств Рутокен ОТР:

![](https://dev.rutoken.ru/download/attachments/223117354/image-2025-11-5_16-5-36.png?version=1&modificationDate=1762348111000&api=v2)

## Секретные ключи сгенерированы внутри контура организации

1. Администратор генерирует секретные ключи на сервере.
2. Происходит инициализация Рутокен ОТР одним из следующих способов:
1. Пользователь добавляет секретный ключ в приложение на Android и самостоятельно импортирует секретный ключ на токен по NFC. Наиболее удобным и предпочтительным способом добавления секретного ключа в приложение является сканирование QR-кода, который отображается на клиенте. Кроме того, существует возможность вручную ввести секретный ключ в приложении.



      **Пример содержимого QR-кода для инициализации:**





      ```
      otpauth://totp/Rutoken:?secret=PTCSFHAAXGA44KIEPYY5GVBCH7SZXCDA&issuer=Rutoken&algorithm=SHA1&digits=6&period=30)
      ```

2. Администратор поточно импортирует секретные ключи по NFC на Рутокен ОТР с помощью txt-файла и приложения на Windows.

При необходимости администратор может изменить настройки протокола TOTP. В таком случае настройки также должны быть изменены во время инициализации устройств.

# Почему одноразовые пароли на сервере и Рутокен ОТР могут не совпадать и как это предотвратить

Рутокен OTP, как и любое другое автономное устройство с часами, подвержен временному дрейфу (накоплению ошибки показаний часов), из-за которого одноразовые пароли на устройстве и сервере могут не совпасть при попытке аутентификации. Данную проблему можно устранить через регулярную переинициализацию устройств Рутокен ОТР, что повышает нагрузку на администратора и ухудшает пользовательский опыт. Другой вариант — на этапе подготовки к аутентификации учесть возможное расхождение во времени на стороне сервера следующими способами:

- Решение с ограничениями — расширение окна допустимых одноразовых паролей в соответствии с [RFC6238](https://www.ietf.org/rfc/rfc6238.txt) (раздел 6 «Resynchronization»).

Сервер при получении одноразового пароля рассчитывает с своей стороны одноразовый пароль как для текущего момента времени, так и для смежных (\+/\- 2) интервалов времени. Если хотя бы один из сгенерированных сервером одноразовых паролей совпадет с присланным пользователем, то аутентификация будет считаться успешной.
- Полноценное решение — реализация механизма адаптации времени.

Проверка совпадения одноразового пароля пользователя с одноразовым паролем не от текущего момента времени, а от одного из соседних интервалов. Если такое происходит, серверу следует сохранить вычисленное смещение в единицах интервалов, чтобы для последующих аутентификаций проверять смещенный набор одноразовых паролей, рассчитываемых сервером.

Блок-схема предложенного алгоритма адаптации времени:

![](https://dev.rutoken.ru/download/attachments/223117354/image-2025-11-5_16-5-57.png?version=1&modificationDate=1762348111000&api=v2)

# Примеры реализации

Пример свободных реализаций на github:

- Python — [PyOTP](https://github.com/pyauth/pyotp);
- Node.js — [optlib](https://github.com/yeojz/otplib);
- C — [OATH Token Library](https://github.com/googleworkspace/apps-script-oauth2);
- Ruby — [rotp](https://github.com/mdp/rotp).

Дополнительно реализацию сценариев подготовки и аутентификации с использованием Рутокен ОТР можно посмотреть на демонстрационном ресурсе [demoauth.rutoken.ru](http://demoauth.rutoken.ru/). Секретные ключи генерируются на стороне сервера. Пользователь самостоятельно добавляет секретный ключ в приложение на Android через сканирование QR-кода и импортирует секретный ключ на токен по NFC.

Полезные ссылки

- [Инструкция к демо-порталу](https://dev.rutoken.ru/pages/viewpage.action?pageId=150241345);
- [Исходный код демо-портала](https://github.com/AktivCo/rutoken-totpfido2-demo/tree/main);
- В демо-проекте используется [библиотека OTP.NET](https://github.com/kspearrin/Otp.NET) для реализации TOTP на языке C#;
- [Реализация функции проверки одноразового кода, с учетом временного дрейфа](https://github.com/AktivCo/rutoken-totpfido2-demo/blob/main/RutokenTotpFido2Demo/Services/TotpService.cs#L96).

- No labels